<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Keuangan Katering</title>
    <meta name="description" content="Aplikasi untuk mengelola keuangan katering dengan fitur input manual dan perhitungan otomatis">
    <meta name="theme-color" content="#28a745">
    
    <!-- Manifest untuk PWA -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1>Aplikasi Keuangan Katering</h1>
            <p>Kelola pemasukan dan pengeluaran usaha katering Anda</p>
        </div>
    </header>

    <main class="container">
        <!-- Spinner Loading -->
        <div class="spinner"></div>
        
        <!-- Form Pemasukan -->
        <div class="card">
            <div class="card-header">
                <h2>Tambah Pemasukan</h2>
            </div>
            <div class="card-body">
                <form id="incomeForm">
                    <div class="form-group">
                        <label for="incomeDate" class="form-label">Tanggal</label>
                        <input type="date" class="form-control" id="incomeDate" required>
                    </div>
                    <div class="form-group">
                        <label for="incomeDescription" class="form-label">Deskripsi</label>
                        <input type="text" class="form-control" id="incomeDescription" placeholder="Contoh: Pembayaran catering" required>
                    </div>
                    <div class="form-group">
                        <label for="incomeAmount" class="form-label">Jumlah (Rp)</label>
                        <input type="number" class="form-control" id="incomeAmount" placeholder="Contoh: 2500000" min="0" step="1000" required>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">Tambah Pemasukan</button>
                </form>
            </div>
        </div>

        <!-- Form Pengeluaran -->
        <div class="card">
            <div class="card-header">
                <h2>Tambah Pengeluaran</h2>
            </div>
            <div class="card-body">
                <form id="expenseForm">
                    <div class="form-group">
                        <label for="expenseDate" class="form-label">Tanggal</label>
                        <input type="date" class="form-control" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDescription" class="form-label">Deskripsi</label>
                        <input type="text" class="form-control" id="expenseDescription" placeholder="Contoh: Belanja bahan baku" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount" class="form-label">Jumlah (Rp)</label>
                        <input type="number" class="form-control" id="expenseAmount" placeholder="Contoh: 500000" min="0" step="1000" required>
                    </div>
                    <button type="submit" class="btn btn-danger btn-block">Tambah Pengeluaran</button>
                </form>
            </div>
        </div>

        <!-- Ringkasan Keuangan dan Ekspor -->
        <div class="summary-cards">
            <div class="summary-card">
                <h3>Total Pemasukan</h3>
                <div class="amount positive">Rp <span id="totalIncome">0</span></div>
            </div>
            <div class="summary-card">
                <h3>Total Pengeluaran</h3>
                <div class="amount negative">Rp <span id="totalExpense">0</span></div>
            </div>
            <div class="summary-card">
                <h3>Sisa Uang</h3>
                <div class="amount balance">Rp <span id="currentBalance">0</span></div>
            </div>
        </div>

        <!-- Tombol Ekspor -->
        <div class="card">
            <div class="card-body">
                <button class="btn btn-info btn-block" onclick="exportToExcel()">Ekspor ke Excel</button>
            </div>
        </div>

        <!-- Laporan Transaksi -->
        <div class="table-container">
            <div class="table-header">
                <h2>Laporan Transaksi</h2>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Hari</th>
                            <th>Deskripsi</th>
                            <th>Pemasukan</th>
                            <th>Pengeluaran</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal untuk pesan -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Pesan</h3>
                <button class="close">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Prompt Install PWA -->
    <div class="pwa-install-prompt" id="pwaInstallPrompt">
        <p>Install aplikasi ini untuk pengalaman yang lebih baik!</p>
        <div class="pwa-install-buttons">
            <button class="btn btn-success" onclick="installPWA()">Install</button>
            <button class="btn btn-secondary" onclick="closeInstallPrompt()">Nanti</button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Format number as currency
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID').format(number);
        }

        // Show loading spinner
        function showLoading(show) {
            const spinner = document.querySelector('.spinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        // Show toast message
        function showToast(message, type) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // Add to body
            document.body.appendChild(toast);
            
            // Remove after delay
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Load transactions
        async function loadTransactions() {
            showLoading(true);
            try {
                const response = await fetch('/api/transactions');
                if (response.ok) {
                    const data = await response.json();
                    updateTransactionsTable(data.transactions);
                    updateSummary(data.summary);
                } else {
                    throw new Error('Gagal memuat data');
                }
            } catch (error) {
                showToast('Gagal memuat data: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Update transactions table
        function updateTransactionsTable(transactions) {
            const tableBody = document.getElementById('transactionsTable');
            tableBody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.day}</td>
                    <td>${transaction.description}</td>
                    <td class="positive">Rp ${formatRupiah(transaction.income)}</td>
                    <td class="negative">Rp ${formatRupiah(transaction.expense)}</td>
                    <td class="balance">Rp ${formatRupiah(transaction.balance)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Update summary
        function updateSummary(summary) {
            document.getElementById('totalIncome').textContent = formatRupiah(summary.total_income);
            document.getElementById('totalExpense').textContent = formatRupiah(summary.total_expense);
            document.getElementById('currentBalance').textContent = formatRupiah(summary.current_balance);
        }

        // Add income
        async function addIncome(event) {
            event.preventDefault();
            showLoading(true);
            
            const date = document.getElementById('incomeDate').value;
            const description = document.getElementById('incomeDescription').value;
            const amount = document.getElementById('incomeAmount').value;
            
            try {
                const response = await fetch('/api/add_income', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date, description, amount })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    document.getElementById('incomeForm').reset();
                    loadTransactions(); // Reload data
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('Terjadi kesalahan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Add expense
        async function addExpense(event) {
            event.preventDefault();
            showLoading(true);
            
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = document.getElementById('expenseAmount').value;
            
            try {
                const response = await fetch('/api/add_expense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date, description, amount })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    document.getElementById('expenseForm').reset();
                    loadTransactions(); // Reload data
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('Terjadi kesalahan: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Export to Excel
        function exportToExcel() {
            showLoading(true);
            fetch('/api/export_excel')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error('Gagal mengekspor data');
                    }
                })
                .then(blob => {
                    showLoading(false);
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'catering_finance_export.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                    showToast('Data berhasil diekspor ke Excel!', 'success');
                })
                .catch(error => {
                    showLoading(false);
                    showToast('Gagal mengekspor data: ' + error.message, 'error');
                });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            document.getElementById('expenseDate').value = today;
            
            // Add event listeners
            document.getElementById('incomeForm').addEventListener('submit', addIncome);
            document.getElementById('expenseForm').addEventListener('submit', addExpense);
            
            // Load initial data
            loadTransactions();
            
            // Close modal when close button is clicked
            document.querySelectorAll('.close').forEach(button => {
                button.addEventListener('click', function() {
                    document.getElementById('messageModal').style.display = 'none';
                });
            });
        });
    </script>
</body>
</html>